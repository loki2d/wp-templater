#Notification - уведомления о новых сообщениях в трансляции

##Цель
Уведомления служат для того, что бы довести до пользователя информацию о новых
сообщениях в трансляции.

##Как работает
Через сокет соединение можно отправлять !всем! активным пользователям уведомление через протокол wapm.

##WAMP сообщение
В пуш-уведомлении от сервера приходит объект трансляции с вложенным объектом вида:

```
{
    "@class":58,
    "@context":"page",
    "@id":5149,
    "@image" : {
      "@class":12,
      "@context":"photo",
      "@id":9822719,
      "meta":[
        {
            "name":"width",
            "value":720
        },
        {
            "name":"height",
            "value":480
        },
        {
            "name":"ratio",
            "value":1.5
        }
      ],
      "ru":{
          "title":"Медведев признал, что выход на базовый уровень заработной платы, который установлен указами президента, во многом достигается за счет различного рода надбавок и премий. Фото: Дмитрий Астахов/ТАСС"
      },
      "url":"/share/i/12/9822719/"
    },
    "@type":[
        "broadcast"
    ],
    "childs":[
        {
            "@context":"cope",
            "@id":4176553,
            "@type":"twitter",
            "childs":[
                {
                    "@class":"twitter",
                    "@context":"person",
                    "@id":"317147065",
                    "description":"спец.корр. Комсомольской правды: Чечня,Дагестан,Беслан,Косово,Южная Осетия,Египет,Ливия,Сирия Египет,Косово,Афган,Киев,Крым,Луганск,Славянск,Донецк...",
                    "image":{
                        "@context":"photo",
                        "url":"http://pbs.twimg.com/profile_images/3687049899/f8231bf5dd90aa4402935b547ea00c94_normal.jpeg"
                    },
                    "name":"Дмитрий Стешин",
                    "screenName":"kp_steshin",
                    "url":"http://twitter.com/kp_steshin"
                },
                {
                    "@context":"paragraph",
                    "ru":{
                        "hashtags":[
                            "начало",
                            "обозрение",
                            "определение",
                            "ук",
                            "мародёрство",
                            "дурь"
                        ],
                        "stats":{
                            "noun":6,
                            "text":133,
                            "words":23
                        },
                        "text":"@PavelZolnikov Вы для начала посмотрите определение мародерства в УК, чтобы дурь свою всю сразу не вываливать, на всеобщее обозрение."
                    }
                }
            ],
            "meta":[
                {
                    "name":"created",
                    "value":"2014-09-15T00:50:49"
                },
                {
                    "name":"modified",
                    "value":"2014-09-15T00:50:49"
                },
                {
                    "name":"published",
                    "value":"2014-09-15T00:50:40"
                }
            ]
        }
      ],
      "meta":[
      {
          "name":"count",
          "value":452
      },
      {
          "name":"pages",
          "value":23
      },
      {
          "name":"number",
          "value":23
      },
      {
          "name":"completed",
          "value":"2014-09-30T01:19:00"
      },
      {
          "name":"created",
          "value":"2014-08-21T00:22:26"
      },
      {
          "name":"modified",
          "value":"2014-09-15T02:16:41"
      },
      {
          "name":"published",
          "value":"2014-08-18T00:19:00"
      },
      {
          "name":"finished",
          "value":true
      }
  ],
  "publisher":"Сайт «Комсомольской правды»",
  "ru":{
      "title":"Спецкоры «КП» Александр Коц и Дмитрий Стешин передают с юго-востока Украины"
  }
}

Делаем проверку нет ли в localstorage объекта с @id идентификатором трансляции.
если трансляция такой трансляции нет,
создаем новый объект в массиве notifications,
Если есть просто добавляем в массив notificationArray содержимое @childs

```

По @id ищем в localstorage трансляцию. Если такой трансляции нет создаем новую.

```
notifications : [
  123443214 : {
    id : 123443214,
    url : "http://www.kp.ru/daily/26571/3587606/",
    img : "http://s15.stc.all.kpcdn.net/share/i/12/9819459/", // формируется скриптом из @image
    title: "Крым подаст в суд на Украину за «два десятилетия грабежа",
    active : false,
    notificationArray : [
      {
        ... Обект(ы) из массива @childs ...
      }
    ]
  ]
}
```

notifications - массив объектов уведомлений
123443214 - объект уведомления
id - (str) id уведомления совпадает с названием объекта
url, title - (str) заполняются из объекта запрошенного с сервера без изменений
img - (str) формируется из @imageCover

active - (bool) состояние плашки уведомления в браузере пользователя. true если уведомление отрисовано, false если закрыто.

Если такая трансляция есть добавляем в существующий объект в массив notificationArray. Элемент из свойства "childs" (он там должен быть один).

Отрисовываем уведомление. После отрисовки переводим свойства объекта трансляции в active : true.

## Виды уведомлений и их действия в различных ситуациях

Внешний вид на всех страницах сайта один, отличается они лишь поведением при нажатии на область уведомления.

Всего разработано 2 вида поведения (планируется еще 1).

* Пользователь находится на любой другой странице сайта.
* Пользователь находится на странице с трансляцией.
* [Пользователь подписал браузер на уведомления].

### Когда пользователь находится на другой странице сайта

Область уведомления работает как ссылка(кроме крестика) на страницу статьи к которой привязана трансляция.

Перед переходом, убиваем объект трансляции в localstorage.notifications

### Когда пользователь находится на странице трансляции.

Если пользователь кликает в область уведомления (кроме крестика) :

* плавно переносит пользователя к точке отрисовки сообщений.
* Забираем из localstorage данные по всем сообщениям которые накопились в трансляции из массива notificationArray. И добавляем в ленту трансляции

После того как все сообщения отрисованы, убиваем объект трансляции в localstorage.notifications

## Частные случаи
Если уведомление активно (пользователь не закрыл его и не перешел на трансляцию).

Ищем в разметке контейнер уведомления и меняем количество уведомлений при этом создавая визуальный привлекающий внимание.
